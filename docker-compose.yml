version: "3.6"

services:
  auth-db:
    image: postgres:10-alpine
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    env_file:
    - .auth-db-env
    networks:
      - jimmy-auth-net
    expose:
      - '5432'
  auth:
    image: jboss/keycloak:4.8.2.Final
    environment:
      - DB_VENDOR=POSTGRES
      - DB_ADDR=auth-db
      - PROXY_ADDRESS_FORWARDING=true
    env_file:
      - .auth-env
    depends_on:
       - auth-db
    networks:
      - jimmy-auth-net
      - jimmy-net
    ports:
      - '8082:8080'

  back-db:
    image: postgres:10-alpine
    volumes:
      - back_db_data:/var/lib/postgresql/data
    env_file:
      - .db-env
    networks:
      - jimmy-back-net
    expose:
      - '5432'
  back:
    image: alecharp/jimmy-back:latest
    env_file:
      - .db-env
      - .keycloak-client-env
    environment:
      - POSTGRES_HOST=back-db
      - SPRING_PROFILES_ACTIVE=production
      - KEYCLOAK_CLIENT_ID=jimmy-back
    depends_on:
      - back-db
      - auth
    networks:
      - jimmy-back-net
      - jimmy-net
    expose:
      - '8080'

  front:
    image: alecharp/jimmy-front:latest
    env_file:
      - .keycloak-client-env
    environment:
      - KEYCLOAK_CLIENT_ID=jimmy-front
      - BACKEND_URL=http://back:8080
      - PORT=4000
    depends_on:
      - back
      - auth
    networks:
      - jimmy-net
    ports:
      - "80:4000"

networks:
  jimmy-auth-net:
    name: jimmy-auth-net
    internal: true
  jimmy-back-net:
    name: jimmy-back-net
    internal: true
  jimmy-net:
    name: jimmy-net

volumes:
  auth_db_data:
  back_db_data:
